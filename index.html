<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <title>RDO – Impressão responsiva (mobile fix)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet" />
  <style>
    :root{
      --brand:#0f172a;--accent:#2563eb;--muted:#6b7280;
      --footer-h:42mm; /* altura reservada para barra de assinaturas no modo impressão */
    }
    html,body{-webkit-text-size-adjust:100%;height:100%}
    body{background:#f3f4f6;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .container-max{max-width:1100px;margin:24px auto;padding:0 12px}
    .card{border-radius:14px;border:1px solid #e5e7eb;box-shadow:0 10px 24px rgba(15,23,42,.06)}

    /* ---------- PREVIEW / TELA ---------- */
    .pdf-preview{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px}
    .pdf-header{display:flex;align-items:center;gap:14px;border-bottom:2px solid #002060;padding-bottom:8px;margin-bottom:10px}
    .pdf-h-title{color:#002060;font-size:20px;font-weight:700;margin:0}
    .pdf-info{border:1px solid #ddd;border-radius:6px;padding:10px;margin:10px 0;background:#fafafa}
    .pdf-grid{display:flex;flex-wrap:wrap;gap:10px}
    .pdf-col{flex:1;min-width:220px}
    .pdf-label{font-weight:700;color:#002060}
    .pdf-section{margin:10px 0}
    .pdf-section-title{display:block;width:100%;box-sizing:border-box;background:#002060;color:#fff;padding:6px;border-radius:4px;font-weight:700}
    .pdf-table{width:100%;border-collapse:collapse}
    .pdf-table th,.pdf-table td{border:1px solid #ddd;padding:6px;text-align:left;vertical-align:top}
    .pdf-caption{text-align:center;font-style:italic;font-size:.9em;margin-top:4px;color:#374151}

    /* --- Imagens padronizadas 200x200 --- */
    .pdf-imggrid{display:flex;flex-wrap:wrap;gap:12px}
    .pdf-imgwrap{flex:0 0 200px;width:200px;max-width:none;break-inside:avoid}
    .pdf-imgbox{
      width:200px;height:200px;min-height:200px;border:1px solid #ddd;border-radius:6px;
      display:flex;align-items:center;justify-content:center;overflow:hidden;background:#fafafa
    }
    .pdf-imgbox img{width:200px;height:200px;object-fit:contain}

    /* --- Barra de assinatura --- */
    .signature-title{text-align:center;font-weight:700;color:#002060;border-top:1px solid #ddd;padding-top:8px;margin-bottom:6px}
    .signature-grid{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .signature-box{width:23%;min-width:150px;text-align:center}
    .signature-line{height:1px;background:#000;margin:28px 0 6px}
    .signature-name{font-weight:700}
    .signature-role{font-size:.9em;color:#555}

    /* ---------- IMPRESSÃO ---------- */
    @media print{
      @page{ size: A4 portrait; margin: 12mm 10mm 18mm 10mm; }
      body{background:#fff;color:#000;-webkit-print-color-adjust:exact;print-color-adjust:exact}
      .screen-only{display:none !important}

      /* TRAVA de largura para evitar zoom/escala em celulares */
      #pdf-container{
        display:block !important;
        width:190mm;              /* 210mm - (margens horizontais de @page) */
        margin:0 auto;
        font-size:10pt;           /* base de leitura */
        line-height:1.35;
      }
      /* iOS/Android WebKit tende a ampliar fonte no print; reduzimos levemente */
      @supports (-webkit-touch-callout: none){
        #pdf-container{font-size:9.2pt}
      }

      .pdf-table thead{display:table-header-group}
      .pdf-table tr{page-break-inside:avoid;break-inside:avoid}
      .avoid-break,.pdf-header,.pdf-imgwrap,.signature-grid,.signature-box{break-inside:avoid}

      /* Footer fixo repetido em todas as páginas */
      .pdf-footer-fixed{
        position:fixed;left:0;right:0;bottom:0;
        height:var(--footer-h);
        background:#fff; /* evita artefatos */
        z-index:1;
        -webkit-transform:translateZ(0); /* ajuda Safari/iOS */
      }
      .pdf-content{padding-bottom:calc(var(--footer-h) + 6mm)} /* reserva espaço para não sobrepor */
    }

    /* ---------- Layout responsivo de tela ---------- */
    @media (max-width: 991px){
      .container-max{margin:12px auto}
    }

    /* ---------- MINI UI ---------- */
    .thumb{width:200px;height:200px;margin:0;border:2px dashed #e5e7eb;border-radius:.8rem;display:flex;align-items:center;justify-content:center;background:#fafafa;overflow:hidden}
    .thumb img{width:200px;height:200px;object-fit:contain}
  </style>
</head>
<body>
  <div class="container-max screen-only">
    <div class="card p-3 mb-3">
      <div class="d-flex align-items-center justify-content-between">
        <h1 class="h5 m-0">RDO – Preencher &amp; Imprimir</h1>
        <div class="d-flex gap-2">
          <button id="btnPreview" class="btn btn-outline-secondary"><i class="fa-solid fa-eye"></i> Atualizar prévia</button>
          <button id="btnPrint" class="btn btn-primary"><i class="fa-solid fa-print"></i> Imprimir / PDF</button>
        </div>
      </div>
    </div>

    <div class="card p-3 mb-3">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Cliente</label>
          <input id="inCliente" class="form-control" placeholder="Nome do cliente" />
        </div>
        <div class="col-md-4">
          <label class="form-label">Serviço / Obra</label>
          <input id="inObra" class="form-control" placeholder="Descrição da obra" />
        </div>
        <div class="col-md-4">
          <label class="form-label">Nº do Pedido (PC)</label>
          <input id="inPC" class="form-control" placeholder="PC-0000" />
        </div>
        <div class="col-md-4">
          <label class="form-label">Data</label>
          <input id="inData" type="date" class="form-control" />
        </div>
        <div class="col-md-4">
          <label class="form-label">Turno</label>
          <select id="inTurno" class="form-select">
            <option value="">Selecione...</option>
            <option>Manhã (07:30 - 12:00)</option>
            <option>Tarde (12:00 - 17:18)</option>
            <option>Noite (19:00 - 00:00)</option>
            <option>Madrugada (01:00 - 04:48)</option>
            <option>Integral Dia (07:30 - 17:18)</option>
            <option>Integral Noite (19:00 - 04:48)</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Encarregado</label>
          <input id="inEncarregado" class="form-control" placeholder="Nome do encarregado" />
        </div>
        <div class="col-12">
          <label class="form-label">Observações</label>
          <textarea id="inObs" rows="3" class="form-control" placeholder="Anotações gerais do dia"></textarea>
        </div>
        <div class="col-12">
          <label class="form-label">Fotos (200x200 na impressão)</label>
          <input id="inFotos" type="file" accept="image/*" class="form-control" multiple />
          <div class="d-flex flex-wrap gap-2 mt-2" id="thumbs"></div>
        </div>
      </div>
    </div>

    <div class="alert alert-info">
      Dica: no celular, use a opção <b>Compartilhar &gt; Imprimir</b> (iOS) ou o diálogo de impressão do navegador (Android). A largura é travada para evitar “zoom” e a barra de assinaturas é fixa e aparece nas páginas.
    </div>
  </div>

  <!-- ---------- CONTEÚDO DO PDF / PRÉVIA ---------- -->
  <div id="pdf-container" class="container-max">
    <div class="pdf-preview" id="pdfRoot">
      <div class="pdf-doc">
        <div class="pdf-content">
          <header class="pdf-header">
            <div style="width:64px;height:64px;display:flex;align-items:center;justify-content:center;border:1px solid #e5e7eb;border-radius:8px;background:#fafafa">
              <i class="fa-solid fa-hard-hat" style="font-size:28px;color:#1f2937"></i>
            </div>
            <div>
              <h2 class="pdf-h-title">Relatório Diário de Obra (RDO)</h2>
              <div class="text-muted">Prévia de impressão (A4). As imagens serão padronizadas em 200x200.</div>
            </div>
          </header>

          <section class="pdf-info">
            <div class="pdf-grid">
              <div class="pdf-col"><div class="pdf-label">Cliente</div><div id="outCliente">—</div></div>
              <div class="pdf-col"><div class="pdf-label">Serviço / Obra</div><div id="outObra">—</div></div>
              <div class="pdf-col"><div class="pdf-label">Pedido (PC)</div><div id="outPC">—</div></div>
            </div>
            <div class="pdf-grid mt-2">
              <div class="pdf-col"><div class="pdf-label">Data</div><div id="outData">—</div></div>
              <div class="pdf-col"><div class="pdf-label">Turno</div><div id="outTurno">—</div></div>
              <div class="pdf-col"><div class="pdf-label">Encarregado</div><div id="outEncarregado">—</div></div>
            </div>
          </section>

          <section class="pdf-section">
            <span class="pdf-section-title">Observações</span>
            <div id="outObs" class="mt-2">—</div>
          </section>

          <section class="pdf-section">
            <span class="pdf-section-title">Fotos (200x200)</span>
            <div id="outFotos" class="pdf-imggrid mt-2"></div>
          </section>
        </div>

        <!-- Barra de assinaturas fixa (repetida em todas as páginas) -->
        <footer class="pdf-footer-fixed">
          <div class="signature-title">Assinaturas</div>
          <div class="signature-grid px-3">
            <div class="signature-box">
              <div class="signature-line"></div>
              <div class="signature-name" id="sig1">Responsável da Obra</div>
              <div class="signature-role">Assinatura</div>
            </div>
            <div class="signature-box">
              <div class="signature-line"></div>
              <div class="signature-name" id="sig2">Fiscal do Cliente</div>
              <div class="signature-role">Assinatura</div>
            </div>
            <div class="signature-box">
              <div class="signature-line"></div>
              <div class="signature-name" id="sig3">Segurança do Trabalho</div>
              <div class="signature-role">Assinatura</div>
            </div>
            <div class="signature-box">
              <div class="signature-line"></div>
              <div class="signature-name" id="sig4">Qualidade</div>
              <div class="signature-role">Assinatura</div>
            </div>
          </div>
        </footer>
      </div>
    </div>
  </div>

  <script>
    // -------- Helpers --------
    const $ = sel => document.querySelector(sel);
    const byId = id => document.getElementById(id);

    function atualizarPrevia(){
      byId('outCliente').textContent = byId('inCliente').value || '—';
      byId('outObra').textContent = byId('inObra').value || '—';
      byId('outPC').textContent = byId('inPC').value || '—';
      byId('outData').textContent = byId('inData').value || '—';
      byId('outTurno').textContent = byId('inTurno').value || '—';
      const enc = byId('inEncarregado').value || '—';
      byId('outEncarregado').textContent = enc;
      byId('sig1').textContent = enc || 'Responsável da Obra';

      const obs = byId('inObs').value?.trim() || '—';
      byId('outObs').textContent = obs.replace(/\n{2,}/g, '\n');

      // Fotos -> grid 200x200
      const grid = byId('outFotos');
      grid.innerHTML = '';
      for(const file of (byId('inFotos').files || [])){
        const wrap = document.createElement('div');
        wrap.className = 'pdf-imgwrap';
        const box = document.createElement('div');
        box.className = 'pdf-imgbox';
        const img = document.createElement('img');
        img.alt = file.name;
        box.appendChild(img);
        wrap.appendChild(box);
        // opcional legenda:
        // const cap = document.createElement('div'); cap.className='pdf-caption'; cap.textContent = file.name; wrap.appendChild(cap);

        const reader = new FileReader();
        reader.onload = e => { img.src = e.target.result; };
        reader.readAsDataURL(file);

        grid.appendChild(wrap);
      }
    }

    // Atualiza prévia ao alterar qualquer campo
    ['inCliente','inObra','inPC','inData','inTurno','inEncarregado','inObs','inFotos'].forEach(id=>{
      const el = byId(id);
      if(!el) return;
      el.addEventListener('input', atualizarPrevia);
      if(id==='inFotos') el.addEventListener('change', atualizarPrevia);
    });

    // Botões
    byId('btnPreview')?.addEventListener('click', atualizarPrevia);
    byId('btnPrint')?.addEventListener('click', ()=>{
      atualizarPrevia();
      // pequeno atraso ajuda o render no mobile antes do diálogo de impressão
      setTimeout(()=> window.print(), 80);
    });

    // Init
    atualizarPrevia();
  </script>
</body>
</html>
